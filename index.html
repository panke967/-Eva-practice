<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>æ¬¢è¿æ¥åˆ°Evaçš„ç»ƒä¹ å°è¯¾å ‚ / Bienvenidos al mini-aula de prÃ¡ctica de Eva</title>
    <style>
        /* å…¨å±€æ ·å¼ä¿æŒä¸å˜ */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body{
            background:#ffd27f;
            font-family: "Times New Roman", serif;
            color:#333;
            padding:20px;
            margin:0;
        }

        h1,h2{text-align:center;margin:15px 0;}
        h1{color:#d93025;font-size:28px;}
        h2{color:#333;font-size:22px;}

        .page-title {
            text-align: center;
            color: #d93025;
            font-size: 32px;
            margin-bottom: 15px;
            font-family: "Times New Roman", serif;
            font-weight: bold;
        }
        .page-subtitle {
            text-align: center;
            color: #333;
            font-size: 20px;
            margin-bottom: 40px;
            font-weight: normal;
            font-family: "Times New Roman", serif;
        }

        .section {
            max-width: 800px;
            margin: 0 auto 40px;
            padding: 30px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s ease;
            min-height: 250px;
        }
        .section:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }
        .section-title {
            color: #d93025;
            font-size: 22px;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd27f;
            font-family: "Times New Roman", serif;
            text-align: center;
        }

        .btn {
            display: inline-block;
            padding: 12px 28px;
            background: #ffd27f;
            border: none;
            border-radius: 8px;
            color: #333;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: "Times New Roman", serif;
            font-weight: 500;
        }
        .btn:hover {
            background: #ffc04d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* è¿”å›æŒ‰é’®æ ·å¼ï¼ˆå’Œä¸»æŒ‰é’®ä¸€è‡´ï¼Œå°ºå¯¸ç¨å°ï¼‰ */
        .back-btn {
            background: #ffd27f;
            border: none;
            border-radius: 6px;
            color: #333;
            font-family: "Times New Roman", serif;
            font-size: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 16px;
            margin-bottom: 10px;
        }
        .back-btn:hover {
            background: #ffc04d;
            transform: translateY(-2px);
        }

        /* å•å…ƒæŒ‰é’®æ ·å¼ï¼ˆå’Œä¸»æŒ‰é’®ä¸€è‡´ï¼‰ */
        .unit-btn {
            padding: 10px 30px;
            background: #ffd27f;
            border: none;
            border-radius: 6px;
            color: #333;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: "Times New Roman", serif;
        }
        .unit-btn:hover {
            background: #ffc04d;
            transform: translateY(-2px);
        }

        .reading-container { position: relative; }
        .reading-content {
            font-size: 17px;
            line-height: 2.2;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 25px;
            font-family: "Times New Roman", serif;
            color: #333;
        }

        #musicBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: #d93025;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            transition: all 0.3s ease;
            font-family: "Times New Roman", serif;
        }
        #musicBtn:hover {
            background: #c02516;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <h1 class="page-title">æ¬¢è¿æ¥åˆ°Evaçš„ç»ƒä¹ å°è¯¾å ‚</h1>
    <h2 class="page-subtitle">Bienvenidos al mini-aula de prÃ¡ctica de Eva</h2>

    <button id="musicBtn" title="æ’­æ”¾/æš‚åœ">â–¶</button>
    <audio id="bgMusic" loop>
        <source src="https://raw.githubusercontent.com/panke967/-Eva-practice/main/river-flows-in-you.mp3" type="audio/mpeg">
        Tu navegador no soporta el audio.
    </audio>

    <!-- é˜…è¯»ç»ƒä¹ æ¿å— -->
    <div class="section">
        <h3 class="section-title">ğŸ“– é˜…è¯»-å•è¯å¼ºåŒ–å¤ä¹ </h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
            <button id="readingRefreshBtn" class="btn">è¿›å…¥é˜…è¯»ç»ƒä¹ </button>
            <button id="nextTextBtn" class="btn" style="display: none;">ä¸‹ä¸€ç¯‡</button>
        </div>
        <div class="reading-container">
            <div class="reading-content" id="lectura"></div>
        </div>
    </div>

    <!-- ç¿»è¯‘-è¯æ±‡å¼ºåŒ–ç»ƒä¹  -->
    <div class="section">
        <h3 class="section-title">ğŸŒ ç¿»è¯‘-è¯æ±‡å¼ºåŒ–ç»ƒä¹ </h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
            <button id="translationStart" class="btn">è¿›å…¥ç¿»è¯‘ç»ƒä¹ </button>
        </div>
        <div id="translationBox" style="display: none; margin-top: 15px;">
            <div style="font-size: 14px; color: #666; margin-bottom: 15px; text-align: center;">
                å·²ç¿»è¯‘ï¼š<span id="translationTotalCount">0</span> é¢˜
            </div>
            <div style="font-size: 20px; color: #d93025; margin-bottom: 10px; text-align: center;">
                <span id="translationPrompt"></span>
            </div>
            <!-- æ£€æŸ¥æ ¸å¯¹çš„æŒ‰é’® -->
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <textarea id="translationInput" placeholder="è¯·è¾“å…¥è¥¿ç­ç‰™è¯­ç¿»è¯‘"
                    style="
                        padding: 8px; 
                        width: 260px; 
                        min-height: 80px; 
                        font-family:'Times New Roman',serif;
                        border: 1px solid #ddd; 
                        border-radius: 6px;
                        background: #f9f9f9; 
                        outline: none; 
                        font-size: 16px; 
                        resize: vertical;
                        white-space: pre-wrap;
                        overflow-wrap: break-word;
                        word-break: break-word;
                        overflow-y: auto;">
                </textarea>
                <button id="translationCheck" style="background: #ffd27f;color: #333; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 10px; font-family:'Times New Roman',serif;">
                    æ£€æŸ¥æ ¸å¯¹
                </button>
            </div>
            <!-- æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="translationAnswer" style="display: none; text-align: center; margin: 15px 0; font-size: 16px; color: #009100; font-weight: bold;"></div>
            <!-- ä¸‹ä¸€å¥/ç»“æŸç»ƒä¹ æŒ‰é’® -->
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 10px;">
                <button id="translationNext" style="background: #ffd27f;color: #333;border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px;font-family:'Times New Roman',serif;" disabled>
                    ä¸‹ä¸€å¥
                </button>
                <button id="translationEnd" style="background: #ffd27f;color: #333;border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px;font-family:'Times New Roman',serif;">
                    ç»“æŸç»ƒä¹ 
                </button>
            </div>
        </div>
    </div>

    <!-- å¬å†™-å•è¯ç†Ÿæ‚‰å¤ä¹  -->
    <div class="section">
        <h3 class="section-title">âœï¸ å¬å†™-å•è¯ç†Ÿæ‚‰å¤ä¹ </h3>
        <button id="dictadoStart" class="btn" style="display: block; margin: 0 auto;">è¿›å…¥å¬å†™ç»ƒä¹ </button>

        <!-- å•å…ƒé€‰æ‹©ç•Œé¢ -->
        <div id="unitSelect" style="display:none; margin-top:15px; text-align:center;">
            <h4 style="margin-bottom: 15px; color: #333;">è¯·é€‰æ‹©è¦å¬å†™çš„å•å…ƒ</h4>
            <!-- è¿”å›æŒ‰é’® -->
            <button id="backToDictadoStart" class="back-btn">â† è¿”å›</button>
            <!-- å•å…ƒæŒ‰é’®ç»„ -->
            <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap; margin-top:10px;">
                <button class="unit-btn" data-unit="1">1å•å…ƒ</button>
                <button class="unit-btn" data-unit="2">2å•å…ƒ</button>
                <button class="unit-btn" data-unit="3">3å•å…ƒ</button>
                <button class="unit-btn" data-unit="4">4å•å…ƒ</button>
            </div>
        </div>

        <!-- å­¦ç”Ÿä¿¡æ¯å¼¹çª— -->
        <div id="studentInfoPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; position: relative;">
                <button id="closePopupBtn" style="position: absolute; top: 10px; right: 15px; background: transparent; border: none; font-size: 22px; color: #666; cursor: pointer; padding: 5px;">Ã—</button>
                <h3 style="margin-bottom: 20px; text-align: center; font-family: 'Times New Roman', serif; color: #d93025;">è¯·è¾“å…¥ä½ çš„ä¿¡æ¯</h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-family: 'Times New Roman', serif; color: #333;">å§“åï¼š</label>
                        <input type="text" id="studentName" style="width: 100%; padding: 10px; font-family: 'Times New Roman', serif; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-family: 'Times New Roman', serif; color: #333;">å­¦å·ï¼š</label>
                        <input type="text" id="studentId" style="width: 100%; padding: 10px; font-family: 'Times New Roman', serif; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <button id="confirmInfoBtn" class="btn" style="width: 100%;">ç¡®è®¤</button>
                </div>
            </div>
        </div>

        <!-- å¬å†™ç•Œé¢ -->
        <div id="dictadoBox" style="display:none;margin-top:15px;">
            <div style="display:flex;flex-direction:column;align-items:center;gap:15px;">
                <div style="font-size:14px;color:#666;margin-bottom:5px;text-align:center;">
                    å·²å¬å†™ï¼š<span id="dictadoTotalCount">0</span> é¢˜
                </div>
                <div id="dictadoPrompt" style="font-size:22px;color:#d93025;margin-bottom:10px;text-align:center;"></div>
                <div style="display:flex;align-items:center;gap:10px; width: 100%; max-width: 400px;">
                    <input id="dictadoInput" type="text" placeholder="è¯·è¾“å…¥è¥¿è¯­å•è¯" 
                        style="
                        padding: 10px;
                        width: 100%;
                        font-family:'Times New Roman',serif;
                        font-size: 16px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        background: #f9f9f9;
                        outline: none;">
                    <button id="dictadoCheck" class="btn">ç¡®å®š</button>
                </div>
                <div style="font-size:10px;color:#666;line-height:1.6;text-align:left;width: 100%; max-width: 400px; padding: 0 10px;">
                    1. è¯·å„ä½åŒå­¦ä½¿ç”¨è‹±è¯­/è¥¿è¯­é”®ç›˜è¾“å…¥<br>
                    2. æœ‰é˜´é˜³æ€§çš„å•è¯è¯·å†™å…¨ï¼ˆä½¿ç”¨/éš”å¼€,ä¾‹:bueno/naï¼‰<br>
                    3. é™¤ä¸“æœ‰åè¯éœ€é¦–å­—æ¯å¤§å†™ï¼Œå…¶ä½™å•è¯é»˜è®¤é¦–å­—æ¯ä¸ºå°å†™
                </div>
                <div id="dictadoResult" style="margin-top:10px;font-weight:bold;text-align:center;">
                    <span id="resultText"></span>
                    <button id="playPronunciation" class="btn" style="margin-left:10px; padding:5px 10px; font-size:14px; display:none;">ğŸ”Š å¬è¯»éŸ³</button>
                </div>
                <div style="margin-top:5px;display:flex;gap:15px;">
                    <button id="dictadoNext" class="btn" disabled>ä¸‹ä¸€ä¸ª</button>
                    <button id="dictadoEnd" class="btn">ç»“æŸå¬å†™</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é˜…è¯»æ¨¡å—ï¼šä» lectura.csv è¯»å–çŸ­æ–‡
        const ReadingHandler = {
            texts: [],
            init() {
                this.loadCSV('lectura.csv');
                this.bindEvents();
            },

            async loadCSV(filePath) {
                try {
                    // ä½ çš„ GitHub ä¿¡æ¯
                    const githubUsername = "panke967";
                    const githubRepo = "-Eva-practice";
                    const githubBranch = "main";
                    const rawUrl = `https://raw.githubusercontent.com/${githubUsername}/${githubRepo}/${githubBranch}/${filePath}`;
                    
                    const response = await fetch(rawUrl);
                    if (!response.ok) throw new Error(`æ–‡ä»¶ ${filePath} åŠ è½½å¤±è´¥ï¼ˆé“¾æ¥ï¼š${rawUrl}ï¼‰`);
                    const text = await response.text();
                    this.parseCSV(text);
                } catch (err) {
                    alert('é˜…è¯»çŸ­æ–‡åŠ è½½å¤±è´¥ï¼š' + err.message);
                    console.error(err);
                }
            },

            parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                this.texts = [];

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const cleanLine = line.replace(/^"|"$/g, '').replace(/,,+/g, ',').replace(/^,|,$/g, '');
                    if (cleanLine) {
                        this.texts.push(cleanLine);
                    }
                }

                console.log(`é˜…è¯»æ¨¡å—åŠ è½½å®Œæˆ ${this.texts.length} ç¯‡çŸ­æ–‡`);
                if (this.texts.length === 0) alert('âš ï¸ æœªä» CSV ä¸­è¯»å–åˆ°ä»»ä½•çŸ­æ–‡ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
            },

            bindEvents() {
                document.getElementById('readingRefreshBtn').addEventListener('click', () => this.loadRandomText());
                document.getElementById('nextTextBtn').addEventListener('click', () => this.loadRandomText());
                document.getElementById('musicBtn').addEventListener('click', this.toggleMusic);
            },

            loadRandomText() {
                if (this.texts.length === 0) {
                    alert('æš‚æ— å¯ç”¨é˜…è¯»çŸ­æ–‡ï¼Œè¯·ç¨åé‡è¯•');
                    return;
                }
                const randomIdx = Math.floor(Math.random() * this.texts.length);
                const text = this.texts[randomIdx];
                const lecturaDiv = document.getElementById('lectura');
                lecturaDiv.innerHTML = text.replace(/â€”/g, '<span style="display: inline-block; margin: 0 5px;">â€”</span>');
                
                document.getElementById('readingRefreshBtn').disabled = true;
                document.getElementById('readingRefreshBtn').style.opacity = "0.6";
                document.getElementById('nextTextBtn').style.display = "inline-block";
            },

            toggleMusic() {
                const musicBtn = document.getElementById('musicBtn');
                const bgMusic = document.getElementById('bgMusic');
                const isPlaying = !bgMusic.paused;

                if (isPlaying) {
                    bgMusic.pause();
                    musicBtn.textContent = 'â–¶';
                } else {
                    bgMusic.play().then(() => {
                        musicBtn.textContent = 'âšâš';
                    }).catch(err => {
                        console.log('éŸ³ä¹æ’­æ”¾è¢«æ‹¦æˆªï¼š', err);
                        alert('è¯·æ‰‹åŠ¨å…è®¸æµè§ˆå™¨æ’­æ”¾éŸ³é¢‘');
                    });
                }
            }
        };

        // å¬å†™æ¨¡å—
        const DictadoHandler = {
            palabras: [],
            usedIndexes: [],
            idx: 0,
            correct: 0,
            total: 0,
            isChecked: false,
            currentWord: null,
            wrongWords: [],
            studentName: '',
            studentId: '',
            startTime: null,
            isDictadoStarted: false,
            selectedUnit: null,

            init() {
                this.bindEvents();
            },

            endDictado() {
                document.getElementById('dictadoBox').style.display = 'none';
                const accuracy = this.total > 0 ? (this.correct / this.total * 100).toFixed(2) : 0;
                let wrongListHtml = '';
                if (this.wrongWords.length > 0) {
                    wrongListHtml = this.wrongWords.map((item, index) => `
                        <li style="margin: 8px 0; line-height: 1.5;">
                            ${index + 1}. ä½ çš„è¾“å…¥ï¼š<span style="color:red;">${item.input}</span> â†’ 
                            æ­£ç¡®ç­”æ¡ˆï¼š<span style="color:green;">${item.correctEs}</span>ï¼ˆ${item.cn}ï¼‰
                        </li>
                    `).join('');
                } else {
                    wrongListHtml = '<li style="color:#666;">ğŸ‰ æ²¡æœ‰é”™è¯ï¼Œå¤ªæ£’äº†ï¼</li>';
                }

                const endTime = Date.now();
                const totalMs = endTime - this.startTime;
                const minutes = Math.floor(totalMs / 60000);
                const seconds = Math.floor((totalMs % 60000) / 1000);
                const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                const finishTime = new Date(endTime).toLocaleString('zh-CN');

                const resultHtml = `
                <div style="font-size: 16px; line-height: 2; padding: 10px;">
                    <p>ğŸ“ å­¦ç”Ÿä¿¡æ¯ï¼š</p>
                    <p>å§“åï¼š${this.studentName}</p>
                    <p>å­¦å·ï¼š${this.studentId}</p>
                    <p>ç»ƒä¹ å•å…ƒï¼šç¬¬ ${this.selectedUnit} å•å…ƒ</p>
                    <p style="margin-top: 15px;">ğŸ“Š å¬å†™ç»“æœï¼š</p>
                    <p>æ€»é¢˜æ•°ï¼š${this.total} é“</p>
                    <p>æ­£ç¡®æ•°ï¼š${this.correct} é“</p>
                    <p>æ­£ç¡®ç‡ï¼š${accuracy}%</p>
                    <p>å®Œæˆæ—¶é—´ï¼š${finishTime}</p>
                    <p>æ€»è€—æ—¶ï¼š${formattedTime}</p>
                    <p style="margin-top: 15px; font-weight: bold;">é”™è¯å¤ä¹ ï¼š</p>
                    <ul style="margin: 5px 0; padding-left: 20px;">${wrongListHtml}</ul>
                </div>
                `;

                const popup = document.createElement('div');
                popup.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: white; padding: 20px; border: 2px solid #d93025; border-radius: 8px;
                    max-width: 400px; width: 85%; max-height: 70vh; overflow-y: auto; z-index: 9999; padding-top: 40px;
                `;
                popup.innerHTML = `
                    ${resultHtml}
                    <button id="popupCloseBottom" style="
                        margin-top: 15px; padding: 8px 20px; 
                        background: #d93025; color: white; 
                        border: none; border-radius: 4px; cursor: pointer;
                        display: block; margin-left: auto; margin-right: auto;">
                        å…³é—­
                    </button>
                `;

                const mask = document.createElement('div');
                mask.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9998;';
                document.body.appendChild(mask);
                document.body.appendChild(popup);

                document.getElementById('popupCloseBottom').addEventListener('click', () => {
                    document.body.removeChild(popup);
                    document.body.removeChild(mask);
                    document.getElementById('dictadoStart').style.display = 'block';
                });

                this.resetDictado();
            },

            resetDictado() {
                this.correct = 0;
                this.total = 0;
                this.wrongWords = [];
                this.isChecked = false;
                this.currentWord = null;
                this.usedIndexes = [];
                this.studentName = '';
                this.studentId = '';
                document.getElementById('dictadoInput').value = '';
                document.getElementById('dictadoResult').textContent = '';
                document.getElementById('dictadoCheck').disabled = false;
                document.getElementById('dictadoNext').disabled = true;
                document.getElementById('dictadoTotalCount').textContent = '0';
                this.startTime = null;
                this.isDictadoStarted = false;
                this.selectedUnit = null;
            },

            async cargarCSV(unit) {
                try {
                    // ä½ çš„ GitHub ä¿¡æ¯ï¼ˆå·²å¡«å…¥ï¼‰
                    const githubUsername = "panke967";
                    const githubRepo = "-Eva-practice";
                    const githubBranch = "main";
                    
                    const file = `1u${unit}.csv`;
                    const rawUrl = `https://raw.githubusercontent.com/${githubUsername}/${githubRepo}/${githubBranch}/${file}`;
                    
                    const res = await fetch(rawUrl);
                    if (!res.ok) throw new Error(`å•å…ƒ ${unit} çš„æ–‡ä»¶ã€Œ${file}ã€åŠ è½½å¤±è´¥ï¼ˆé“¾æ¥ï¼š${rawUrl}ï¼‰`);
                    
                    const text = await res.text();
                    this.palabras = [];

                    const lines = text.trim().split('\n');
                    const dataLines = lines.slice(1);

                    dataLines.forEach((line, lineIdx) => {
                        const cleanLine = line.trim()
                            .replace(/^"|"$/g, '')
                            .replace(/,,+/g, ',')
                            .replace(/^,|,$/g, '');

                        if (!cleanLine) return;

                        const parts = cleanLine.split(',').map(s => {
                            return s.trim().replace(/^"|"$/g, '')
                                .replace(/ï¼Œ/g, '')
                                .replace(/\s+/g, ' ');
                        }).filter(Boolean);

                        let es, cn, pos;
                        if (parts.length === 3) {
                            [es, cn, pos] = parts;
                        } else if (parts.length === 2) {
                            [es, cn] = parts;
                            pos = 'æœªåˆ†ç±»';
                        } else {
                            console.warn(`CSV ç¬¬ ${lineIdx+2} è¡Œæ ¼å¼é”™è¯¯ï¼š${line}ï¼ˆå·²è·³è¿‡ï¼‰`);
                            return;
                        }

                        const finalEs = es.trim().replace(/[\u2000-\u206F\uFEFF\u00A0]/g, '');
                        this.palabras.push({ es: finalEs, cn: cn.trim(), pos: pos.trim() });
                    });

                    console.log(`å•å…ƒ ${unit} åŠ è½½å®Œæˆ ${this.palabras.length} ä¸ªå•è¯`);
                    if (this.palabras.length === 0) alert(`âš ï¸ å•å…ƒ ${unit} æœªåŠ è½½åˆ°ä»»ä½•å•è¯ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼`);
                    return true;
                } catch (err) {
                    alert('âŒ å•è¯åŠ è½½å¤±è´¥ï¼š' + err.message);
                    console.error(err);
                    return false;
                }
            },

            bindEvents() {
                // è¿›å…¥å¬å†™ç»ƒä¹  â†’ æ˜¾ç¤ºå•å…ƒé€‰æ‹©
                document.getElementById('dictadoStart').addEventListener('click', () => {
                    document.getElementById('dictadoStart').style.display = 'none';
                    document.getElementById('unitSelect').style.display = 'block';
                });

                // è¿”å›æŒ‰é’® â†’ éšè—å•å…ƒé€‰æ‹©ï¼Œæ˜¾ç¤ºè¿›å…¥æŒ‰é’®
                document.getElementById('backToDictadoStart').addEventListener('click', () => {
                    document.getElementById('unitSelect').style.display = 'none';
                    document.getElementById('dictadoStart').style.display = 'block';
                    this.resetDictado();
                });

                // é€‰æ‹©å•å…ƒ â†’ åŠ è½½å¯¹åº”å•è¯
                document.querySelectorAll('.unit-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const unit = e.currentTarget.dataset.unit;
                        this.selectedUnit = unit;

                        alert(`æ­£åœ¨åŠ è½½å•å…ƒ ${unit} çš„å•è¯ï¼Œè¯·ç¨å€™...`);
                        const loadSuccess = await this.cargarCSV(unit);
                        if (loadSuccess) {
                            document.getElementById('unitSelect').style.display = 'none';
                            document.getElementById('studentInfoPopup').style.display = 'flex';
                        }
                    });
                });

                // ç¡®è®¤å­¦ç”Ÿä¿¡æ¯ â†’ å¼€å§‹å¬å†™
                document.getElementById('confirmInfoBtn').addEventListener('click', () => {
                    const name = document.getElementById('studentName').value.trim();
                    const id = document.getElementById('studentId').value.trim();
                    
                    if (!name || !id) {
                        alert('è¯·è¾“å…¥å§“åå’Œå­¦å·');
                        return;
                    }
                    
                    this.studentName = name;
                    this.studentId = id;
                    
                    document.getElementById('studentInfoPopup').style.display = 'none';
                    document.getElementById('dictadoBox').style.display = 'block';
                    this.nuevaPalabra();
                    
                    document.getElementById('studentName').value = '';
                    document.getElementById('studentId').value = '';

                    if (!this.isDictadoStarted) {
                        this.startTime = Date.now();
                        this.isDictadoStarted = true;
                    }
                });

                // å…³é—­å­¦ç”Ÿä¿¡æ¯å¼¹çª—
                document.getElementById('closePopupBtn').addEventListener('click', () => {
                    document.getElementById('studentInfoPopup').style.display = 'none';
                    document.getElementById('unitSelect').style.display = 'block';
                });

                // å¬å†™æ£€æŸ¥
                document.getElementById('dictadoCheck').addEventListener('click', () => {
                    this.verificar();
                });

                // ä¸‹ä¸€ä¸ªå•è¯
                document.getElementById('dictadoNext').addEventListener('click', () => {
                    this.nuevaPalabra();
                });

                // å›è½¦æäº¤
                document.getElementById('dictadoInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.verificar();
                });

                // ç»“æŸå¬å†™
                document.getElementById('dictadoEnd').addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦ç»“æŸå¬å†™å—ï¼Ÿä¼šæ˜¾ç¤ºä½ çš„é”™è¯å¤ä¹ åˆ—è¡¨ï½')) {
                        this.endDictado();
                    }
                });
            },

            nuevaPalabra() {
                if (this.palabras.length === 0) return;

                this.isChecked = false;
                const checkBtn = document.getElementById('dictadoCheck');
                const nextBtn = document.getElementById('dictadoNext');
                checkBtn.disabled = false;
                nextBtn.disabled = true;

                let availableIndexes = this.palabras
                    .map((_, index) => index)
                    .filter(index => !this.usedIndexes.includes(index));

                if (availableIndexes.length === 0) {
                    this.usedIndexes = [];
                    availableIndexes = this.palabras.map((_, index) => index);
                }

                const randomIdx = availableIndexes[
                    Math.floor(Math.random() * availableIndexes.length)
                ];
                this.currentWord = this.palabras[randomIdx];
                this.usedIndexes.push(randomIdx);

                document.getElementById('dictadoPrompt').innerHTML = 
                    `<span style="color:#d93025;">${this.currentWord.cn}</span>ã€€<span style="color:#666;">(${this.currentWord.pos})</span>`;

                document.getElementById('dictadoInput').value = '';
                document.getElementById('dictadoResult').textContent = '';
                document.getElementById('dictadoInput').focus();
            },

            removeAccents(str) {
                return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            },

            verificar() {
                if (this.isChecked) return;
                const input = document.getElementById('dictadoInput').value.trim();
                if (!input) return;

                const correctEs = this.currentWord.es.trim();
                let correctForms;
                if (correctEs.includes(',')) {
                    correctForms = correctEs.split(',')
                        .map(form => {
                            const trimForm = form.trim();
                            return trimForm === 'na' ? 'a' : trimForm;
                        })
                        .filter(Boolean);
                } else {
                    correctForms = [correctEs];
                }

                const isCorrect = correctForms.includes(input);
                const resultBox = document.getElementById('dictadoResult');
                
                if (isCorrect) {
                    resultBox.innerHTML = `
                        <span style="color:green;">âœ… æ­£ç¡®ï¼</span>
                        <button class="playPronunciation btn" style="margin-left:10px; padding:5px 10px; font-size:14px;">ğŸ”Š å¬è¯»éŸ³</button>
                    `;
                    this.correct++;
                } else {
                    resultBox.innerHTML = `
                        <span style="color:red;">âŒ æ­£ç¡®ç­”æ¡ˆï¼š${correctEs}</span>
                        <button class="playPronunciation btn" style="margin-left:10px; padding:5px 10px; font-size:14px;">ğŸ”Š å¬è¯»éŸ³</button>
                    `;
                    const isDuplicate = this.wrongWords.some(item => item.correctEs === correctEs && item.input === input);
                    if (!isDuplicate) {
                        this.wrongWords.push({
                            input: input,
                            correctEs: correctEs,
                            cn: this.currentWord.cn
                        });
                    }
                }

                resultBox.querySelector('.playPronunciation').addEventListener('click', () => {
                    const wordToPronounce = correctEs.split(',')[0].trim();
                    this.playPronunciation(wordToPronounce);
                });

                this.isChecked = true;
                document.getElementById('dictadoCheck').disabled = true;
                document.getElementById('dictadoNext').disabled = false;
                this.total++;
                document.getElementById('dictadoTotalCount').textContent = this.total;
            },

            playPronunciation(word) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'es-ES';
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾åŠŸèƒ½');
                }
            }
        };

        // ç¿»è¯‘æ¨¡å—
        const TranslationHandler = {
            words: [],
            totalCount: 0,
            usedIndexes: [],
            countedIndexes: [],
            currentIndex: 0,
            init() {
                this.loadCSV('fanyi.csv');
                this.bindEvents();
            },

            async loadCSV(filePath) {
                try {
                    // ä½ çš„ GitHub ä¿¡æ¯
                    const githubUsername = "panke967";
                    const githubRepo = "-Eva-practice";
                    const githubBranch = "main";
                    const rawUrl = `https://raw.githubusercontent.com/${githubUsername}/${githubRepo}/${githubBranch}/${filePath}`;
                    
                    const response = await fetch(rawUrl);
                    if (!response.ok) throw new Error(`HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç : ${response.status}ï¼ˆé“¾æ¥ï¼š${rawUrl}ï¼‰`);
                    
                    const text = await response.text();
                    const lines = text.trim().split('\n');
                    this.words = [];

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        let parts = [];
                        let inQuotes = false;
                        let currentPart = '';
                        for (const char of line) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                parts.push(currentPart.trim());
                                currentPart = '';
                            } else {
                                currentPart += char;
                            }
                        }
                        parts.push(currentPart.trim().replace(/^"|"$/g, ''));

                        if (parts.length === 3) {
                            const [es, cn, pos] = parts;
                            if (es && cn && pos) {
                                this.words.push({ es, cn, pos });
                            }
                        } else {
                            console.warn(`ç¿»è¯‘CSVç¬¬${i+1}è¡Œæ ¼å¼é”™è¯¯ï¼š${line}ï¼ˆè§£æå‡º${parts.length}åˆ—ï¼Œéœ€3åˆ—ï¼‰`);
                        }
                    }

                    console.log('ç¿»è¯‘è¯æ±‡åŠ è½½å®Œæˆï¼Œå…±', this.words.length, 'ä¸ª');
                } catch (err) {
                    alert('ç¿»è¯‘CSVåŠ è½½å¤±è´¥ï¼š' + err.message);
                }
            },

            bindEvents() {
                document.getElementById('translationStart').addEventListener('click', () => {
                    if (this.words.length === 0) {
                        alert('è¯æ±‡æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•');
                        return;
                    }
                    document.getElementById('translationBox').style.display = 'block';
                    this.nextWord();
                    this.totalCount = 0;
                    document.getElementById('translationTotalCount').textContent = '0';
                });

                document.getElementById('translationCheck').addEventListener('click', () => {
                    const currentWord = this.words[this.currentIndex];
                    const answerEl = document.getElementById('translationAnswer');
                    answerEl.textContent = `æ­£ç¡®ç­”æ¡ˆï¼š${currentWord.es}`;
                    answerEl.style.display = 'block';

                    if (!this.countedIndexes.includes(this.currentIndex)) {
                        this.totalCount++;
                        this.countedIndexes.push(this.currentIndex);
                        document.getElementById('translationTotalCount').textContent = this.totalCount;
                    }

                    document.getElementById('translationNext').disabled = false;
                });

                document.getElementById('translationNext').addEventListener('click', () => {
                    this.nextWord();
                });

                document.getElementById('translationEnd').addEventListener('click', () => {
                    if (confirm(`ç¡®å®šç»“æŸç»ƒä¹ å—ï¼Ÿå·²å®Œæˆ${this.totalCount}é¢˜`)) {
                        document.getElementById('translationBox').style.display = 'none';
                        this.reset();
                    }
                });
            },

            nextWord() {
                document.getElementById('translationInput').value = '';
                document.getElementById('translationAnswer').style.display = 'none';
                document.getElementById('translationNext').disabled = true;

                if (this.usedIndexes.length >= this.words.length) {
                    this.usedIndexes = [];
                    this.countedIndexes = [];
                }

                let randomIdx;
                do {
                    randomIdx = Math.floor(Math.random() * this.words.length);
                } while (this.usedIndexes.includes(randomIdx));

                this.currentIndex = randomIdx;
                this.usedIndexes.push(randomIdx);
                
                const currentWord = this.words[randomIdx];
                document.getElementById('translationPrompt').textContent = 
                    `${currentWord.cn}ï¼ˆ${currentWord.pos}ï¼‰`;
                
                document.getElementById('translationInput').focus();
            },

            reset() {
                this.totalCount = 0;
                this.usedIndexes = [];
                this.countedIndexes = [];
                document.getElementById('translationTotalCount').textContent = '0';
            }
        };

        // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
        window.addEventListener('DOMContentLoaded', () => {
            ReadingHandler.init();
            DictadoHandler.init();
            TranslationHandler.init();
        });
    </script>
</body>
</html>
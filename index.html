<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>æ¬¢è¿æ¥åˆ°Evaçš„ç»ƒä¹ å°è¯¾å ‚ / Bienvenidos al mini-aula de prÃ¡ctica de Eva</title>
<style>
/* å…¨å±€æ ·å¼ï¼šç»Ÿä¸€å­—ä½“ä¸º Times New Romanï¼Œç®€æ´å­¦ä¹ é£ */
* { margin: 0; padding: 0; box-sizing: border-box; }

body{
  background:#fff9e6;
  font-family: "Times New Roman", serif; /* å…¨å±€å­—ä½“ç»Ÿä¸€ä¸º Times New Roman */
  color:#333;
  padding:20px;
  margin:0;
}

h1,h2{text-align:center;margin:15px 0;}
h1{color:#d2691e;font-size:24px;}
h2{color:#333;font-size:20px;}

/* æ ‡é¢˜æ ·å¼ï¼šè¿˜åŸåŸå§‹æ–‡æœ¬ï¼Œå­—ä½“ä¿æŒ Times New Roman */
.page-title {
  text-align: center;
  color: #d2691e;
  font-size: 28px;
  margin-bottom: 8px;
  font-family: "Times New Roman", serif;
}
.page-subtitle {
  text-align: center;
  color: #666;
  font-size: 18px;
  margin-bottom: 30px;
  font-weight: normal;
  font-family: "Times New Roman", serif;
}

/* æ¿å—æ ·å¼ */
.section {
  max-width: 1000px;
  margin: 0 auto 30px;
  padding: 25px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: box-shadow 0.3s ease;
  min-height: 200px; /* å…³é”®ï¼šåˆå§‹çŠ¶æ€ä¸‹æ‰€æœ‰æ¿å—æœ€å°é«˜åº¦ä¸€è‡´ */
}
.section:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.12); }
.section-title {
  color: #333;
  font-size: 20px;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid #f0f0f0;
  font-family: "Times New Roman", serif;
}

/* æŒ‰é’®æ ·å¼ï¼šå­—ä½“ç»Ÿä¸€ä¸º Times New Roman */
.btn {
  display: inline-block;
  padding: 12px 24px;
  background: #ffd27f;
  border: none;
  border-radius: 8px;
  color: #333;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: "Times New Roman", serif;
}
.btn:hover {
  background: #ffc04d;
  transform: translateY(-2px);
}
.btn:active { transform: translateY(0); }

/* é˜…è¯»å†…å®¹æ ·å¼ï¼šè¥¿è¯­å•è¯å­—ä½“ç¡®ä¿ä¸º Times New Roman */
.reading-container { position: relative; }
.reading-content {
  font-size: 17px;
  line-height: 2.2;
  padding-left: 20px;
  margin-top: 25px;
  font-family: "Times New Roman", serif;
}

/* éŸ³ä¹æ§åˆ¶å™¨ */
#musicBtn {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: none;
  background: #ffd27f;
  color: #fff;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
  transition: all 0.3s ease;
  font-family: "Times New Roman", serif;
}
#musicBtn:hover {
  background: #ffc04d;
  transform: scale(1.05);
}
</style>
</head>
<body>
<!-- é¡µé¢æ ‡é¢˜ï¼šä¸¥æ ¼è¿˜åŸåŸå§‹æ–‡æœ¬ï¼Œæœªåšä»»ä½•ä¿®æ”¹ -->
<h1>æ¬¢è¿æ¥åˆ°Evaçš„ç»ƒä¹ å°è¯¾å ‚</h1>
<h1>Bienvenidos al mini-aula de prÃ¡ctica de Eva</h1>

<!-- éŸ³ä¹æ§åˆ¶å™¨ -->
<button id="musicBtn" title="æ’­æ”¾/æš‚åœ">â–¶</button>
<audio id="bgMusic" loop>
  <source src="river-flows-in-you.mp3" type="audio/mpeg">
  Tu navegador no soporta el audio.
</audio>

<!-- é˜…è¯»ç»ƒä¹ æ¿å—ï¼ˆæ ¸å¿ƒï¼‰ -->
<div class="section">
  <h3 class="section-title">ğŸ“– é˜…è¯»-å•è¯å¼ºåŒ–å¤ä¹ </h3>
  <!-- æ–°å¢æŒ‰é’®å®¹å™¨ï¼Œç”¨äºå¯¹é½æŒ‰é’® -->
  <div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <button id="refreshBtn" class="btn">è¿›å…¥é˜…è¯»ç»ƒä¹ </button>
    <button id="nextTextBtn" class="btn" style="display: none;">ä¸‹ä¸€ç¯‡</button>
  </div>

<!-- é˜…è¯»å†…å®¹å®¹å™¨ -->
  <div class="reading-container">
    <div class="reading-content" id="lectura"></div>
  </div>
</div>


<!-- âœï¸ å¬å†™-å•è¯ç†Ÿæ‚‰å¤ä¹  -->
<div class="section">
  <h3 class="section-title">âœï¸ å¬å†™-å•è¯ç†Ÿæ‚‰å¤ä¹ </h3>
  <button id="dictadoStart" class="btn">è¿›å…¥å¬å†™ç»ƒä¹ </button>

<!-- åœ¨å¬å†™æ¿å—çš„HTMLä¸­æ·»åŠ éšè—çš„å¼¹çª—ç»“æ„ -->
<div id="studentInfoPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px;">
    <h3 style="margin-bottom: 20px; text-align: center; font-family: 'Times New Roman', serif;">è¯·è¾“å…¥ä½ çš„ä¿¡æ¯</h3>
    <div style="display: flex; flex-direction: column; gap: 15px;">
      <div>
        <label style="display: block; margin-bottom: 5px; font-family: 'Times New Roman', serif;">å§“åï¼š</label>
        <input type="text" id="studentName" style="width: 100%; padding: 8px; font-family: 'Times New Roman', serif;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-family: 'Times New Roman', serif;">å­¦å·ï¼š</label>
        <input type="text" id="studentId" style="width: 100%; padding: 8px; font-family: 'Times New Roman', serif;">
      </div>
      <button id="confirmInfoBtn" class="btn" style="width: 100%;">ç¡®è®¤</button>
    </div>
  </div>
</div>



<!-- ç‚¹è¿›åæ˜¾ç¤ºçš„åŒºåŸŸ -->
<div id="dictadoBox" style="display:none;margin-top:15px;">
  <!-- æ–°å¢å±…ä¸­å®¹å™¨ï¼šè®©æç¤ºã€è¾“å…¥æ¡†ã€æŒ‰é’®éƒ½å±…ä¸­ -->
  <div style="display:flex;flex-direction:column;align-items:center;gap:15px;">
    <!-- æ–°å¢è®¡æ•°æ˜¾ç¤ºï¼ˆå°±åœ¨è¿™è¡Œæ·»åŠ ï¼‰ -->
    <div style="font-size:14px;color:#666;margin-bottom:5px;text-align:center;">
      å·²å¬å†™ï¼š<span id="dictadoTotalCount">0</span> é¢˜
    </div>
    <div id="dictadoPrompt" style="font-size:20px;color:#d93025;margin-bottom:10px;text-align:center;"></div>
    <!-- è¾“å…¥æ¡†+ç¡®å®šæŒ‰é’® å®¹å™¨ï¼ˆæ°´å¹³å±…ä¸­ï¼‰ -->
    <div style="display:flex;align-items:center;gap:10px;">
      <input id="dictadoInput" type="text" placeholder="è¯·è¾“å…¥è¥¿è¯­å•è¯" style="padding:8px;width:260px;font-family:'Times New Roman',serif;border:none;border-bottom:2px solid #d93025;background:transparent;outline:none;">
      <button id="dictadoCheck" class="btn">ç¡®å®š</button>
    </div>
        <!-- æ–°å¢æç¤ºæ–‡å­—ï¼ˆ3å¥è¯å„å ä¸€è¡Œï¼Œå†…éƒ¨ä¸æ¢è¡Œï¼‰ -->
    <div style="font-size:10px;color:#666;line-height:1.6;text-align:left;width:260px;">
      1. è¯·å„ä½åŒå­¦ä½¿ç”¨è‹±è¯­/è¥¿è¯­é”®ç›˜è¾“å…¥<br>
      2. æœ‰é˜´é˜³æ€§çš„å•è¯è¯·å†™å…¨ï¼ˆä½¿ç”¨é€—å·éš”å¼€ï¼‰<br>
      3. é™¤ä¸“æœ‰åè¯éœ€é¦–å­—æ¯å¤§å†™ï¼Œå…¶ä½™å•è¯é»˜è®¤é¦–å­—æ¯ä¸ºå°å†™
    </div>
    <!-- ç»“æœæç¤ºï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰ -->
    <div id="dictadoResult" style="margin-top:10px;font-weight:bold;text-align:center;"></div>
    <!-- åœ¨dictadoBoxåŒºåŸŸçš„ç»“æœæç¤ºéƒ¨åˆ†æ·»åŠ æ’­æ”¾æŒ‰é’®å®¹å™¨ -->
<div id="dictadoResult" style="margin-top:10px;font-weight:bold;text-align:center;">
  <span id="resultText"></span>
  <button id="playPronunciation" class="btn" style="margin-left:10px; padding:5px 10px; font-size:14px; display:none;">ğŸ”Š å¬è¯»éŸ³</button>
</div>
    <!-- ä¸‹ä¸€ä¸ªæŒ‰é’® + ç»“æŸå¬å†™æŒ‰é’®ï¼ˆåŒä¸€è¡Œå±…ä¸­ï¼Œä¿æŒæ ·å¼ä¸€è‡´ï¼‰ -->
    <div style="margin-top:5px;display:flex;gap:10px;">
      <button id="dictadoNext" class="btn" disabled>ä¸‹ä¸€ä¸ª</button>
      <button id="dictadoEnd" class="btn">ç»“æŸå¬å†™</button>
    </div>
  </div>
</div>

<script>
// çŸ­æ–‡æ•°æ®ï¼šå®Œå…¨æ›¿æ¢ä¸ºä½ æä¾›çš„12ç¯‡çŸ­æ–‡
const textosFijos = [
  // çŸ­æ–‡1
  "Susana es de PerÃº, de Lima. Ella estÃ¡ en Madrid con su familia. Hoy ella no va al campus. Ella y su hermano mayor desayunan cafÃ© y leche. Su hermano trabaja en el banco. Ellos se levantan tarde. Por la noche, salen a conocer la ciudad.",

  // çŸ­æ–‡2
  "Mi amigo Juan vive en una casa grande. Ã‰l tiene dos habitaciones. Por la tarde, Juan vuelve del instituto. Primero, Ã©l se cepilla los dientes en el cuarto de baÃ±o. Luego, su abuela prepara la cena. Nosotros comemos un poco de pan y carne con alegrÃ­a.",

  // çŸ­æ–‡3
  "Nosotros somos de China. Vivimos en este paÃ­s. Estudiamos lengua y cultura. Vemos la vida universitaria con alegrÃ­a. Hacemos muchos trabajos de casa. Cada dÃ­a es nuevo y volvemos a empezar.",

  // çŸ­æ–‡4
  "VÃ­ctor y Pablo organizan su horario. Ellos estÃ¡n muy ocupados. Leen la lecciÃ³n y repasan en la biblioteca. Salen del campus a las nueve. Ellos vienen a la residencia y duermen. Los aÃ±os de doctorado son apretados.",

  // çŸ­æ–‡5
  "Yo desayuno con mi familia. Mi hermana se peina despuÃ©s de desayunar. Luego vamos a la escuela juntos. Yo tomo el metro y ella toma el autobÃºs. Yo vuelvo a casa por la tarde. Preparo la cena sin descansar.",

  // çŸ­æ–‡6
  "Ustedes tienen que presentarse ante la clase. Dicen su nombre. Luego hablan de su paÃ­s. Todos escuchan bien. DespuÃ©s, el profesor hace preguntas. Aplaudimos y decimos ã€Šgraciasã€‹ al terminar.",

  // çŸ­æ–‡7
  "Mi familia vive en Lima. Mi hermano mayor estudia en la universidad. Mi hermana menor va a la escuela. Mi madre es profesora de inglÃ©s. Mi padre es mÃ©dico. Yo estoy aquÃ­ en Madrid, pero voy a volver en verano.",

  // çŸ­æ–‡8
  "Ellos vienen al comedor al mediodÃ­a. Almuerzan juntos. Hoy hablan de su paÃ­s. Ellos son latinoamericanos: uno es cubano y el otro es peruano. Terminan de comer a la una en punto y van a la biblioteca.",

  // çŸ­æ–‡9
  "â€”Â¿QuÃ© haces tÃº aquÃ­ por la maÃ±ana? <br> â€”Yo preparo mi doctorado. <br>â€”Â¿Por quÃ© vienes al campus? <br>â€”Porque quiero terminar antes del verano. <br>â€”Â¿EstÃ¡s contento con el horario? <br>â€”SÃ­, estoy contento, pero es muy apretado.",

  // çŸ­æ–‡10
  "Nosotros estudiamos lengua en la universidad. Vivimos en la residencia cerca del campus. Por la noche repasamos la lecciÃ³n. Queremos terminar el curso con alegrÃ­a. Hablamos de la vida en EspaÃ±a sin descansar mucho.",

  // çŸ­æ–‡11
  "Yo me llamo Ana. Soy estudiante de espaÃ±ol. Mi amigo Paco es chileno y es estudiante tambiÃ©n. Conocemos a un profesor de China. Decimosã€Šmucho gustoã€‹al profesor. Ã‰l es de China, pero vive aquÃ­.",

  // çŸ­æ–‡12
  "TomÃ¡s se levanta temprano por la maÃ±ana. Ã‰l desayuna en casa con su padre. Su padre trabaja en el hospital. DespuÃ©s, TomÃ¡s toma el autobÃºs para el instituto. Por la tarde, Ã©l vuelve a casa y hace la tarea."
];

// ä¿®æ”¹ReadingHandlerå¯¹è±¡
const ReadingHandler = {
  init() {
    this.bindEvents();
  },

  bindEvents() {
    // åˆ·æ–°çŸ­æ–‡æŒ‰é’®äº‹ä»¶ï¼šç‚¹å‡»åˆ‡æ¢12ç¯‡çŸ­æ–‡
    document.getElementById('refreshBtn').addEventListener('click', () => this.loadRandomText());
    // ä¸‹ä¸€ç¯‡æŒ‰é’®äº‹ä»¶
    document.getElementById('nextTextBtn').addEventListener('click', () => this.loadRandomText());
    // éŸ³ä¹æ§åˆ¶å™¨äº‹ä»¶
    document.getElementById('musicBtn').addEventListener('click', this.toggleMusic);
  },

  // åŠ è½½éšæœºçŸ­æ–‡ï¼ˆä»12ç¯‡ä¸­éšæœºé€‰æ‹©ï¼‰
  loadRandomText() {
    const randomIdx = Math.floor(Math.random() * textosFijos.length);
    const text = textosFijos[randomIdx];
    const lecturaDiv = document.getElementById('lectura');
    
    // æ˜¾ç¤ºæ–‡ç« å†…å®¹å¹¶ä¿ç•™å¯¹è¯æ ¼å¼
    lecturaDiv.innerHTML = text.replace(/â€”/g, '<span style="display: inline-block; margin: 0 5px;">â€”</span>');
    
    // æ˜¾ç¤ºä¸‹ä¸€ç¯‡æŒ‰é’®ï¼Œéšè—/ç¦ç”¨è¿›å…¥é˜…è¯»æŒ‰é’®
    document.getElementById('refreshBtn').disabled = true;
    document.getElementById('refreshBtn').style.opacity = "0.6";
    document.getElementById('nextTextBtn').style.display = "inline-block";
  },

  // éŸ³ä¹æ’­æ”¾/æš‚åœæ§åˆ¶
  toggleMusic() {
    const musicBtn = document.getElementById('musicBtn');
    const bgMusic = document.getElementById('bgMusic');
    const isPlaying = !bgMusic.paused;

    if (isPlaying) {
      bgMusic.pause();
      musicBtn.textContent = 'â–¶';
    } else {
      bgMusic.play().then(() => {
        musicBtn.textContent = 'âšâš';
      }).catch(err => {
        console.log('éŸ³ä¹æ’­æ”¾è¢«æ‹¦æˆªï¼š', err);
        alert('è¯·æ‰‹åŠ¨å…è®¸æµè§ˆå™¨æ’­æ”¾éŸ³é¢‘');
      });
    }
  }
};

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', () => {
  ReadingHandler.init();
});

</script>

<script>
/* ========== å¬å†™æ¨¡å—ï¼ˆ4æ­¥æµç¨‹ï¼‰ ========== */
const DictadoHandler = {
  palabras: [],
  usedIndexes: [], // è®°å½•å·²ä½¿ç”¨è¿‡çš„å•è¯ç´¢å¼•
  idx: 0,
  correct: 0,
  total: 0,
  isChecked: false,
  currentWord: null,
  wrongWords: [], // å­˜å‚¨é”™è¯çš„æ•°ç»„ï¼ˆå«è¾“å…¥å’Œæ­£ç¡®ç­”æ¡ˆï¼‰
  studentName: '',  // å­¦ç”Ÿå§“å
  studentId: '',    // å­¦å·

  // ç»“æŸå¬å†™æ–¹æ³•
  endDictado() {
    // 1. éšè—å¬å†™åŒºåŸŸ
    document.getElementById('dictadoBox').style.display = 'none';
    // 2. è®¡ç®—æ­£ç¡®ç‡ï¼ˆä¿ç•™2ä½å°æ•°ï¼‰
    const accuracy = this.total > 0 ? (this.correct / this.total * 100).toFixed(2) : 0;
    // 3. ç”Ÿæˆé”™è¯åˆ—è¡¨HTMLï¼ˆæ— é”™è¯æ˜¾ç¤ºæç¤ºï¼‰
    let wrongListHtml = '';
    if (this.wrongWords.length > 0) {
      wrongListHtml = this.wrongWords.map((item, index) => `
        <li style="margin: 8px 0; line-height: 1.5;">
          ${index + 1}. ä½ çš„è¾“å…¥ï¼š<span style="color:red;">${item.input}</span> â†’ 
          æ­£ç¡®ç­”æ¡ˆï¼š<span style="color:green;">${item.correctEs}</span>ï¼ˆ${item.cn}ï¼‰
        </li>
      `).join('');
    } else {
      wrongListHtml = '<li style="color:#666;">ğŸ‰ æ²¡æœ‰é”™è¯ï¼Œå¤ªæ£’äº†ï¼</li>';
    }
    // 4. å¼¹çª—æ˜¾ç¤ºç»“æœï¼ˆåŒ…å«å­¦ç”Ÿä¿¡æ¯ï¼‰
    const resultHtml = `
      <div style="font-size: 16px; line-height: 2; padding: 10px;">
        <p>ğŸ“ å­¦ç”Ÿä¿¡æ¯ï¼š</p>
        <p>å§“åï¼š${this.studentName}</p>
        <p>å­¦å·ï¼š${this.studentId}</p>
        <p style="margin-top: 15px;">ğŸ“Š å¬å†™ç»“æœï¼š</p>
        <p>æ€»é¢˜æ•°ï¼š${this.total} é“</p>
        <p>æ­£ç¡®æ•°ï¼š${this.correct} é“</p>
        <p>æ­£ç¡®ç‡ï¼š${accuracy}%</p>
        <p style="margin-top: 15px; font-weight: bold;">âŒ é”™è¯å¤ä¹ ï¼š</p>
        <ul style="margin: 5px 0; padding-left: 20px;">${wrongListHtml}</ul>
      </div>
    `;
    const popup = document.createElement('div');
    popup.style.cssText = `
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; padding: 20px; border: 2px solid #d93025; border-radius: 8px;
      max-width: 500px; width: 90%; z-index: 9999;
    `;
    popup.innerHTML = resultHtml + '<button id="closePopup" style="margin-top: 15px; padding: 8px 20px; background: #d93025; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>';
    const mask = document.createElement('div');
    mask.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9998;';
    document.body.appendChild(mask);
    document.body.appendChild(popup);
    // å…³é—­å¼¹çª—
    document.getElementById('closePopup').addEventListener('click', () => {
      document.body.removeChild(popup);
      document.body.removeChild(mask);
    });
    // 5. é‡ç½®å¬å†™çŠ¶æ€ï¼ˆä¸‹æ¬¡æ‰“å¼€é‡æ–°å¼€å§‹ï¼‰
    this.resetDictado();
  },

  // é‡ç½®å¬å†™çŠ¶æ€
  resetDictado() {
    this.correct = 0;
    this.total = 0;
    this.wrongWords = [];
    this.isChecked = false;
    this.currentWord = null;
    this.usedIndexes = [];
    this.studentName = '';  // é‡ç½®å­¦ç”Ÿå§“å
    this.studentId = '';    // é‡ç½®å­¦å·
    document.getElementById('dictadoInput').value = '';
    document.getElementById('dictadoResult').textContent = '';
    document.getElementById('dictadoCheck').disabled = false;
    document.getElementById('dictadoNext').disabled = true;
    document.getElementById('dictadoTotalCount').textContent = '0';
  },

  init() {
    this.cargarCSV();
    this.bindEvents();
    this.createInfoPopup(); // åˆ›å»ºä¿¡æ¯è¾“å…¥å¼¹çª—
  },

  // åˆ›å»ºå­¦ç”Ÿä¿¡æ¯è¾“å…¥å¼¹çª—
  createInfoPopup() {
    const popup = document.createElement('div');
    popup.id = 'studentInfoPopup';
    popup.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;';
    popup.innerHTML = `
      <div style="background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px;">
        <h3 style="margin-bottom: 20px; text-align: center; font-family: 'Times New Roman', serif;">è¯·è¾“å…¥ä½ çš„ä¿¡æ¯</h3>
        <div style="display: flex; flex-direction: column; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-family: 'Times New Roman', serif;">å§“åï¼š</label>
            <input type="text" id="studentName" style="width: 100%; padding: 8px; font-family: 'Times New Roman', serif;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-family: 'Times New Roman', serif;">å­¦å·ï¼š</label>
            <input type="text" id="studentId" style="width: 100%; padding: 8px; font-family: 'Times New Roman', serif;">
          </div>
          <button id="confirmInfoBtn" class="btn" style="width: 100%;">ç¡®è®¤</button>
        </div>
      </div>
    `;
    document.body.appendChild(popup);
  },

  async cargarCSV() {
    try {
      const csvFiles = ['1u1.csv', '1u2.csv', '1u3.csv', '1u4.csv'];
      const texts = await Promise.all(
        csvFiles.map(async (file) => {
          const res = await fetch(file);
          if (!res.ok) throw new Error(`æ–‡ä»¶ ${file} åŠ è½½å¤±è´¥ï¼ˆå¯èƒ½è·¯å¾„é”™è¯¯ï¼‰`);
          return res.text();
        })
      );

      this.palabras = []; // æ¸…ç©ºæ•°ç»„ï¼Œé¿å…é‡å¤åŠ è½½

      texts.forEach(text => {
        const lines = text.trim().split('\n');
        const dataLines = lines.slice(1); // è·³è¿‡è¡¨å¤´

        dataLines.forEach((line, lineIdx) => {
          const cleanLine = line.trim()
            .replace(/^"|"$/g, '') // å»æ‰æ•´è¡Œå‰åçš„åŒå¼•å·
            .replace(/,,+/g, ',') // åˆå¹¶è¿ç»­é€—å·
            .replace(/^,|,$/g, ''); // å»æ‰è¡Œé¦–/è¡Œå°¾é€—å·

          if (!cleanLine) return; // è·³è¿‡ç©ºè¡Œ

          // æŒ‰è‹±æ–‡é€—å·åˆ†å‰²ï¼Œå¾—åˆ°å­—æ®µæ•°ç»„
          const parts = cleanLine.split(',').map(s => {
            // å»æ‰æ¯ä¸ªå­—æ®µå‰åçš„åŒå¼•å·
            return s.trim().replace(/^"|"$/g, '')
              .replace(/ï¼Œ/g, '') // å»æ‰ä¸­æ–‡é€—å·
              .replace(/\s+/g, ' '); // å¤šä½™ç©ºæ ¼åˆå¹¶æˆä¸€ä¸ª
          }).filter(Boolean);

          // å…¼å®¹ã€Œè¯æ€§ä¸ºç©ºã€çš„æƒ…å†µ
          let es, cn, pos;
          if (parts.length === 3) {
            [es, cn, pos] = parts;
          } else if (parts.length === 2) {
            [es, cn] = parts;
            pos = 'æœªåˆ†ç±»'; // ç©ºè¯æ€§é»˜è®¤å€¼
          } else {
            console.warn(`CSV ç¬¬ ${lineIdx+2} è¡Œæ ¼å¼é”™è¯¯ï¼š${line}ï¼ˆå·²è·³è¿‡ï¼‰`);
            return;
          }

          // æœ€ç»ˆæ¸…ç†è¥¿è¯­å­—æ®µï¼ˆé¿å…éšè—å­—ç¬¦ï¼‰
          const finalEs = es.trim().replace(/[\u2000-\u206F\uFEFF\u00A0]/g, '');
          this.palabras.push({ es: finalEs, cn: cn.trim(), pos: pos.trim() });
        });
      });

      console.log(`å…±åŠ è½½ ${this.palabras.length} ä¸ªå•è¯`);
      if (this.palabras.length === 0) alert('âš ï¸ æœªåŠ è½½åˆ°ä»»ä½•å•è¯ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼');
    } catch (err) {
      alert('âŒ å•è¯åŠ è½½å¤±è´¥ï¼š' + err.message);
      console.error(err);
    }
  },

  bindEvents() {
    // 1. è¿›å…¥å¬å†™ç»ƒä¹ æŒ‰é’®ï¼ˆç‚¹å‡»æ˜¾ç¤ºä¿¡æ¯å¼¹çª—ï¼‰
    document.getElementById('dictadoStart').addEventListener('click', () => {
      document.getElementById('studentInfoPopup').style.display = 'flex';
    });

    // 2. ç¡®è®¤ä¿¡æ¯æŒ‰é’®äº‹ä»¶
    document.getElementById('confirmInfoBtn').addEventListener('click', () => {
      const name = document.getElementById('studentName').value.trim();
      const id = document.getElementById('studentId').value.trim();
      
      if (!name || !id) {
        alert('è¯·è¾“å…¥å§“åå’Œå­¦å·');
        return;
      }
      
      // ä¿å­˜å­¦ç”Ÿä¿¡æ¯
      this.studentName = name;
      this.studentId = id;
      
      // éšè—å¼¹çª—å¹¶å¼€å§‹å¬å†™
      document.getElementById('studentInfoPopup').style.display = 'none';
      document.getElementById('dictadoBox').style.display = 'block';
      this.nuevaPalabra();
      
      // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ä¸‹æ¬¡è¾“å…¥
      document.getElementById('studentName').value = '';
      document.getElementById('studentId').value = '';
    });

    // 3. ç¡®å®šæŒ‰é’®ï¼ˆç‚¹å‡»éªŒè¯ç­”æ¡ˆï¼‰
    document.getElementById('dictadoCheck').addEventListener('click', () => {
      this.verificar();
    });

    // 4. ä¸‹ä¸€ä¸ªæŒ‰é’®ï¼ˆç‚¹å‡»åŠ è½½æ–°å•è¯ï¼‰
    document.getElementById('dictadoNext').addEventListener('click', () => {
      this.nuevaPalabra();
    });

    // 5. å›è½¦é”®æäº¤
    document.getElementById('dictadoInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') this.verificar();
    });

    // 6. ç»“æŸå¬å†™æŒ‰é’®
    document.getElementById('dictadoEnd').addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦ç»“æŸå¬å†™å—ï¼Ÿä¼šæ˜¾ç¤ºä½ çš„é”™è¯å¤ä¹ åˆ—è¡¨ï½')) {
        this.endDictado();
      }
    });
  },

  mostrarPrimera() {
    document.getElementById('dictadoBox').style.display = 'block';
    document.getElementById('dictadoNext').textContent = 'ä¸‹ä¸€ä¸ª';
    document.getElementById('dictadoNext').disabled = true;
    this.nuevaPalabra();
  },

  nuevaPalabra() {
    if (this.palabras.length === 0) return;

    // 1. é‡ç½®çŠ¶æ€
    this.isChecked = false;
    const checkBtn = document.getElementById('dictadoCheck');
    const nextBtn = document.getElementById('dictadoNext');
    checkBtn.disabled = false; // å¯ç”¨ã€Œç¡®å®šã€
    nextBtn.disabled = true;  // ç¦ç”¨ã€Œä¸‹ä¸€ä¸ªã€

    // 2. è¿‡æ»¤æœªä½¿ç”¨çš„å•è¯ç´¢å¼•
    const availableIndexes = this.palabras
      .map((_, index) => index)
      .filter(index => !this.usedIndexes.includes(index));

    // å¦‚æœæ‰€æœ‰å•è¯éƒ½å·²ä½¿ç”¨ï¼Œé‡ç½®å·²ä½¿ç”¨åˆ—è¡¨ï¼ˆå¾ªç¯ä½¿ç”¨ï¼‰
    if (availableIndexes.length === 0) {
      this.usedIndexes = [];
      return this.nuevaPalabra(); // é€’å½’é‡æ–°è°ƒç”¨
    }

    // 3. ä»æœªä½¿ç”¨çš„ç´¢å¼•ä¸­éšæœºé€‰æ‹©
    const randomIdx = availableIndexes[
      Math.floor(Math.random() * availableIndexes.length)
    ];
    this.currentWord = this.palabras[randomIdx];
    this.usedIndexes.push(randomIdx); // è®°å½•å·²ä½¿ç”¨çš„ç´¢å¼•

    // 4. æ˜¾ç¤ºæ–°çš„ä¸­æ–‡+è¯æ€§
    document.getElementById('dictadoPrompt').innerHTML = 
      `<span style="color:#d93025;">${this.currentWord.cn}</span>ã€€<span style="color:#666;">(${this.currentWord.pos})</span>`;

    // 5. æ¸…ç©ºè¾“å…¥æ¡†å’Œç»“æœ
    document.getElementById('dictadoInput').value = '';
    document.getElementById('dictadoResult').textContent = '';
    document.getElementById('dictadoInput').focus();
  },

  // å»é™¤é‡éŸ³ç¬¦å·è¾…åŠ©å‡½æ•°
  removeAccents(str) {
    return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  },

verificar() {
  if (this.isChecked) return;
  const input = document.getElementById('dictadoInput').value.trim();
  if (!input) return;

  const correctEs = this.currentWord.es.trim();
  let correctForms;
  if (correctEs.includes(',')) {
    correctForms = correctEs.split(',')
      .map(form => {
        const trimForm = form.trim();
        return trimForm === 'na' ? 'a' : trimForm;
      })
      .filter(Boolean);
  } else {
    correctForms = [correctEs];
  }

  const isCorrect = correctForms.includes(input);
  const resultBox = document.getElementById('dictadoResult');
  
  // æ˜¾ç¤ºç»“æœæ–‡æœ¬å’Œå‘éŸ³æŒ‰é’®
  if (isCorrect) {
    resultBox.innerHTML = `
      <span style="color:green;">âœ… æ­£ç¡®ï¼</span>
      <button class="playPronunciation btn" style="margin-left:10px; padding:5px 10px; font-size:14px;">ğŸ”Š å¬è¯»éŸ³</button>
    `;
    this.correct++;
  } else {
    resultBox.innerHTML = `
      <span style="color:red;">âŒ æ­£ç¡®ç­”æ¡ˆï¼š${correctEs}</span>
      <button class="playPronunciation btn" style="margin-left:10px; padding:5px 10px; font-size:14px;">ğŸ”Š å¬è¯»éŸ³</button>
    `;
    // è®°å½•é”™è¯ï¼ˆé¿å…é‡å¤æ·»åŠ åŒä¸€é“é¢˜çš„é”™è¯¯ï¼‰
    const isDuplicate = this.wrongWords.some(item => item.correctEs === correctEs && item.input === input);
    if (!isDuplicate) {
      this.wrongWords.push({
        input: input, // å­¦ç”Ÿçš„é”™è¯¯è¾“å…¥
        correctEs: correctEs, // æ­£ç¡®ç­”æ¡ˆ
        cn: this.currentWord.cn // ä¸­æ–‡é‡Šä¹‰
      });
    }
  }

  // ç»‘å®šå‘éŸ³æŒ‰é’®äº‹ä»¶
  resultBox.querySelector('.playPronunciation').addEventListener('click', () => {
    // å–ç¬¬ä¸€ä¸ªæ­£ç¡®å½¢å¼å‘éŸ³
    const wordToPronounce = correctEs.split(',')[0].trim();
    this.playPronunciation(wordToPronounce);
  });

  this.isChecked = true;
  document.getElementById('dictadoCheck').disabled = true;
  document.getElementById('dictadoNext').disabled = false;
  this.total++;
  // æ›´æ–°æ˜¾ç¤ºçš„è®¡æ•°
  document.getElementById('dictadoTotalCount').textContent = this.total;
},

// æ–°å¢è¯­éŸ³æ’­æ”¾æ–¹æ³•ï¼ˆéœ€è¦æ·»åŠ åˆ°DictadoHandlerå¯¹è±¡ä¸­ï¼‰
playPronunciation(word) {
  // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ
  if ('speechSynthesis' in window) {
    // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
    window.speechSynthesis.cancel();
    // åˆ›å»ºè¯­éŸ³å®ä¾‹
    const utterance = new SpeechSynthesisUtterance(word);
    // è®¾ç½®ä¸ºè¥¿ç­ç‰™è¯­å‘éŸ³
    utterance.lang = 'es-ES';
    // æ’­æ”¾è¯­éŸ³
    window.speechSynthesis.speak(utterance);
  } else {
    alert('å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾åŠŸèƒ½');
  }
}
};

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', () => DictadoHandler.init());
</script>


</body>
</html>